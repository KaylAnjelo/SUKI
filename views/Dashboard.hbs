<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/AdminStyles.css">
    <script src="/js/notifications.js" defer></script>
    <script src="/js/logout.js" defer></script>
    <link rel="icon" type="image/png" href="/assets/SUKI Logo 2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="logo">SUKI Incorporation</div>
            <nav class="nav">
                <a href="/dashboard" class="nav-item active">
                    <i class="fas fa-chart-line"></i>Dashboard
                </a>
                <div class="nav-item dropdown">
                    <span class="dropdown-toggle">
                    <i class="fas fa-file-alt"></i>Generate Reports
                    </span>
                    <div class="dropdown-menu">
                        <a href="/reports/sales"><i class="fas fa-dollar-sign"></i>Sales</a>
                        <a href="/reports/transactions"><i class="fas fa-receipt"></i>User Transactions</a>
                        <a href="/reports/activity"><i class="fas fa-user-clock"></i>User Activity</a>
                    </div>
                </div>
                 <a href="/transac" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>Transactions
                </a>
                <div class="nav-item dropdown">
                    <span class="dropdown-toggle">
                        <i class="fas fa-users"></i>Users
                    </span>
                    <div class="dropdown-menu">
                        <a href="/users/Redemptions"> <i class="fas fa-coins"></i>Redemptions</a>
                        <a href="/users/UserManagement"><i class="fa-solid fa-fingerprint"></i>Management</a>
                    </div>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>Dashboard</h1>
                <div class="notif-container">
                    <button id="notificationsBtn" class="notif-button"><i class="fas fa-bell"></i></button>
                    <div id="notificationsDropdown" style="display: none;">
                        <ul id="notificationsList"></ul>
                    </div>
                    <form id="logoutForm" action="/logout" method="POST" style="display: inline;">
                        <button type="submit" class="logout">Log out</button>
                    </form>
                </div>
            </div>
           <div class="dash">
                <div class="stats-cards">
                    <div class="card">
                        <p>{{total_owners}}</p>
                        <h3>Total Store Owners</h3>
                    </div>
                    <div class="card">
                        <p>{{total_customers}}</p>
                        <h3>Total Customers</h3>
                    </div>
                    <div class="card">
                        <p>{{total_points}}</p>
                        <h3>Total Points Earned</h3>
                    </div>
                    <div class="card">
                        <p>{{redeemed_points}}</p>
                        <h3>Total Points Redeemed</h3>
                    </div>
                </div>
            </div>
            
            <div class="tables-section">
                <div class="table-container">
                    <h2>Stores</h2>
                    <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Store</th>
                                <th>Location</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{{storesTableRows}}}
                        </tbody>
                    </table>
                    </div>
                </div>

                <div class="table-container">
                    <h2>Recent Transactions</h2>
                    <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Points</th>
                                <th>Store</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{{transactionTableRows}}} 
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
			<div class="charts-row">
				<div class="chart-container">
				  <canvas id="pointsPerDayChart"></canvas>
				</div>
				<div class="chart-container">
				  <canvas id="storeEngagementChart"></canvas>
				</div>
			</div>
        </main>
    </div>
    <script>
  // Safely hydrate chart data
  const pointsPerDayLabels = {{#if pointsPerDayLabels}}{{{pointsPerDayLabels}}}{{else}}[]{{/if}};
  const pointsPerDayData = {{#if pointsPerDayData}}{{{pointsPerDayData}}}{{else}}[]{{/if}};
  const storeLabels = {{#if storeLabels}}{{{storeLabels}}}{{else}}[]{{/if}};
  const storeEngagementData = {{#if storeEngagementData}}{{{storeEngagementData}}}{{else}}[]{{/if}};

  // Register DataLabels plugin for Chart.js
  if (window.Chart && window.ChartDataLabels) {
    Chart.register(ChartDataLabels);
  }

  // Bar Chart: Points Earned Per Day
  const pointsPerDayCtx = document.getElementById('pointsPerDayChart').getContext('2d');
  const pointsPerDayChart = new Chart(pointsPerDayCtx, {
    type: 'bar',
    data: {
      labels: pointsPerDayLabels,
      datasets: [{
        label: 'Points Earned',
        data: pointsPerDayData,
        backgroundColor: '#7D0006',
        borderColor: '#7D0006',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { beginAtZero: true },
        y: { beginAtZero: true }
      }
    }
  });

  const storeEngagementCtx = document.getElementById('storeEngagementChart').getContext('2d');
  const storeEngagementChart = new Chart(storeEngagementCtx, {
    type: 'pie',
    data: {
      labels: storeLabels,
      datasets: [{
        label: 'Customer Engagement',
        data: storeEngagementData,
        backgroundColor: [
          '#7D0006', '#C72C41', '#F5B7B1', '#F8C471', '#7FB3D5', '#27AE60'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          formatter: (value, ctx) => {
            const label = ctx.chart?.data?.labels?.[ctx.dataIndex] || '';
            const data = ctx.dataset?.data || [];
            const total = data.reduce((a, b) => a + (Number(b) || 0), 0);
            const pct = total ? (value / total * 100).toFixed(1) : 0;
            return `${label}: ${value} (${pct}%)`;
          }
        }
      }
    }
  });
</script>
</body>
</html>