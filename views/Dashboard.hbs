<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/css/AdminStyles.css">
    <script src="/js/notifications.js" defer></script>
    <script src="/js/logout.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <link rel="icon" type="image/png" href="/assets/SUKI Logo 2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></button>
            <div class="logo">SUKI Incorporation</div>
            <nav class="nav">
                <a href="/dashboard" class="nav-item active">
                    <i class="fas fa-chart-line"></i><span class="label">Dashboard</span>
                </a>
                <a href="/reports" class="nav-item">
                    <i class="fas fa-file-alt"></i><span class="label">Reports</span>
                </a>
                <a href="/transac" class="nav-item">
                    <i class="fas fa-exchange-alt"></i><span class="label">Transactions</span>
                </a>
                <a href="/users/UserManagement" class="nav-item">
                    <i class="fa-solid fa-fingerprint"></i><span class="label">Users</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <div class="header-left">
                    <h1>Sales Report</h1>
                    <p class="header-date" id="currentDate"></p>
                </div>
                <div class="header-right">
                    <div class="search-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="notif-container">
                        <button id="notificationsBtn" class="notif-button"><i class="fas fa-bell"></i></button>
                        <div id="notificationsDropdown" style="display: none;">
                            <ul id="notificationsList"></ul>
                        </div>
                    </div>
                    <form id="logoutForm" action="/logout" method="POST" style="display: inline;">
                        <button type="submit" class="logout">Log out</button>
                    </form>
                </div>
            </div>
           
            
            <div class="dashboard-cards">
                <div class="dashboard-card product-statistics">
                    <div class="card-header">
                        <div class="card-title">
                            <h2>Store Statistics</h2>
                            <p>Track your store performance</p>
                        </div>
                        <div class="card-dropdown">
                            <select id="productStatsRange">
                                <option>Today</option>
                                <option>This Week</option>
                                <option>This Month</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="circular-chart">
                            <canvas id="productStatsChart"></canvas>
                            <div class="chart-center">
                                <span class="chart-value">{{total_points}}</span>
                                <span class="chart-label">Total Points</span>
                                <div class="chart-badge positive">+5.34%</div>
                            </div>
                        </div>
                        <div class="product-categories">
                            <div class="category-item">
                                <div class="category-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div class="category-info">
                                    <span class="category-name">Store A</span>
                                    <span class="category-value">{{total_owners}}</span>
                                </div>
                                <div class="category-badge positive">+5.2%</div>
                            </div>
                            <div class="category-item">
                                <div class="category-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div class="category-info">
                                    <span class="category-name">Store B</span>
                                    <span class="category-value">{{total_customers}}</span>
                                </div>
                                <div class="category-badge positive">+3.8%</div>
                            </div>
                            <div class="category-item">
                                <div class="category-icon">
                                    <i class="fas fa-store"></i>
                                </div>
                                <div class="category-info">
                                    <span class="category-name">Store C</span>
                                    <span class="category-value">{{total_points}}</span>
                                </div>
                                <div class="category-badge negative">-1.2%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card customer-habits">
                    <div class="card-header">
                        <div class="card-title">
                            <h2>Customer Habits</h2>
                            <p>Track your customer habits</p>
                        </div>
                        <div class="card-dropdown">
                            <select id="customerHabitsRange">
                                <option>This Year</option>
                                <option>This Month</option>
                                <option>This Week</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="habits-chart">
                            <canvas id="customerHabitsChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card customer-growth">
                    <div class="card-header">
                        <div class="card-title">
                            <h2>User Analytics</h2>
                            <p>Track users and store performance</p>
                        </div>
                        <div class="card-dropdown">
                            <select>
                                <option>Today</option>
                                <option>This Week</option>
                                <option>This Month</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="growth-charts">
                            <div class="donut-chart">
                                <canvas id="customerGrowthChart1"></canvas>
                                <div class="chart-center">
                                    <span class="chart-value">{{total_customers}}</span>
                                    <span class="chart-label">Customers</span>
                                </div>
                            </div>
                            <div class="donut-chart">
                                <canvas id="customerGrowthChart2"></canvas>
                                <div class="chart-center">
                                    <span class="chart-value">{{total_owners}}</span>
                                    <span class="chart-label">Store Owners</span>
                                </div>
                            </div>
                        </div>
                        <div class="country-list">
                            <div class="country-item">
                                <span class="country-flag">üè™</span>
                                <span class="country-name">Store Locations</span>
                            </div>
                            <div class="country-item">
                                <span class="country-flag">üë•</span>
                                <span class="country-name">Active Users</span>
                            </div>
                            <div class="country-item">
                                <span class="country-flag">‚≠ê</span>
                                <span class="country-name">Points Earned</span>
                            </div>
                            <div class="country-item">
                                <span class="country-flag">üéÅ</span>
                                <span class="country-name">Points Redeemed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
			<div class="charts-row">
				<div class="chart-container">
				  <canvas id="pointsPerDayChart"></canvas>
				</div>
				<div class="chart-container">
				  <canvas id="storeEngagementChart"></canvas>
				</div>
			</div>
        </main>
    </div>
    <script>
  // Set current date
  document.addEventListener('DOMContentLoaded', function() {
    const dateElement = document.getElementById('currentDate');
    const today = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    };
    dateElement.textContent = today.toLocaleDateString('en-US', options);
  });

  // Safely hydrate chart data
  const pointsPerDayLabels = {{#if pointsPerDayLabels}}{{{pointsPerDayLabels}}}{{else}}[]{{/if}};
  const pointsPerDayData = {{#if pointsPerDayData}}{{{pointsPerDayData}}}{{else}}[]{{/if}};
  const storeLabels = {{#if storeLabels}}{{{storeLabels}}}{{else}}[]{{/if}};
  const storeEngagementData = {{#if storeEngagementData}}{{{storeEngagementData}}}{{else}}[]{{/if}};

  // Register DataLabels plugin for Chart.js
  if (window.Chart && window.ChartDataLabels) {
    Chart.register(ChartDataLabels);
  }

  // Product Statistics Circular Chart
  const productStatsCtx = document.getElementById('productStatsChart').getContext('2d');
  const productStatsChart = new Chart(productStatsCtx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [30, 25, 20, 15, 10],
        backgroundColor: ['#7c0f0f', '#C72C41', '#F5B7B1', '#E0E0E0', '#F0F0F0'],
        borderWidth: 0,
        cutout: '70%'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      }
    }
  });

  // Update function for product stats range
  function updateProductStats(range) {
    const presets = {
      Today: [40, 25, 15, 10, 10],
      'This Week': [30, 25, 20, 15, 10],
      'This Month': [22, 20, 18, 20, 20]
    };
    const data = presets[range] || presets['This Week'];
    productStatsChart.data.datasets[0].data = data;
    productStatsChart.update();
  }

  // Customer Habits Bar Chart
  const customerHabitsCtx = document.getElementById('customerHabitsChart').getContext('2d');
  const customerHabitsChart = new Chart(customerHabitsCtx, {
    type: 'bar',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
      datasets: [{
        label: 'Seen Product',
        data: [25000, 30000, 35000, 43787, 40000, 45000, 50000],
        backgroundColor: '#E0E0E0',
        borderRadius: 4
      }, {
        label: 'Sales',
        data: [20000, 25000, 30000, 39784, 35000, 40000, 45000],
        backgroundColor: '#7c0f0f',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { 
          beginAtZero: true,
          grid: { display: false }
        },
        y: { 
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return (value / 1000) + 'K';
            }
          }
        }
      }
    }
  });

  // Update function for customer habits range
  function updateCustomerHabits(range) {
    const presets = {
      'This Year': {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
        seen: [25000, 30000, 35000, 43787, 40000, 45000, 50000],
        sales: [20000, 25000, 30000, 39784, 35000, 40000, 45000]
      },
      'This Month': {
        labels: ['Wk1', 'Wk2', 'Wk3', 'Wk4'],
        seen: [8000, 9000, 11000, 12000],
        sales: [7000, 8500, 9000, 11000]
      },
      'This Week': {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        seen: [3000, 3200, 3100, 4000, 3800, 4200, 4500],
        sales: [2500, 2800, 2600, 3500, 3200, 3700, 4000]
      }
    };
    const cfg = presets[range] || presets['This Year'];
    customerHabitsChart.data.labels = cfg.labels;
    customerHabitsChart.data.datasets[0].data = cfg.seen;
    customerHabitsChart.data.datasets[1].data = cfg.sales;
    customerHabitsChart.update();
  }

  // Wire up dropdowns
  const productStatsRangeEl = document.getElementById('productStatsRange');
  const customerHabitsRangeEl = document.getElementById('customerHabitsRange');
  if (productStatsRangeEl) {
    productStatsRangeEl.addEventListener('change', (e) => updateProductStats(e.target.value));
  }
  if (customerHabitsRangeEl) {
    customerHabitsRangeEl.addEventListener('change', (e) => updateCustomerHabits(e.target.value));
  }

  // Customer Growth Donut Charts
  const customerGrowthCtx1 = document.getElementById('customerGrowthChart1').getContext('2d');
  const customerGrowthChart1 = new Chart(customerGrowthCtx1, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [70, 30],
        backgroundColor: ['#7c0f0f', '#E0E0E0'],
        borderWidth: 0,
        cutout: '80%'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      }
    }
  });

  const customerGrowthCtx2 = document.getElementById('customerGrowthChart2').getContext('2d');
  const customerGrowthChart2 = new Chart(customerGrowthCtx2, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [60, 40],
        backgroundColor: ['#C72C41', '#E0E0E0'],
        borderWidth: 0,
        cutout: '80%'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      }
    }
  });

  // Original charts (keeping for compatibility)
  const pointsPerDayCtx = document.getElementById('pointsPerDayChart').getContext('2d');
  const pointsPerDayChart = new Chart(pointsPerDayCtx, {
    type: 'bar',
    data: {
      labels: pointsPerDayLabels,
      datasets: [{
        label: 'Points Earned',
        data: pointsPerDayData,
        backgroundColor: '#7D0006',
        borderColor: '#7D0006',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { beginAtZero: true },
        y: { beginAtZero: true }
      }
    }
  });

  const storeEngagementCtx = document.getElementById('storeEngagementChart').getContext('2d');
  const storeEngagementChart = new Chart(storeEngagementCtx, {
    type: 'pie',
    data: {
      labels: storeLabels,
      datasets: [{
        label: 'Customer Engagement',
        data: storeEngagementData,
        backgroundColor: [
          '#7D0006', '#C72C41', '#F5B7B1', '#F8C471', '#7FB3D5', '#27AE60'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold' },
          formatter: (value, ctx) => {
            const label = ctx.chart?.data?.labels?.[ctx.dataIndex] || '';
            const data = ctx.dataset?.data || [];
            const total = data.reduce((a, b) => a + (Number(b) || 0), 0);
            const pct = total ? (value / total * 100).toFixed(1) : 0;
            return `${label}: ${value} (${pct}%)`;
          }
        }
      }
    }
  });
</script>
</body>
</html>