<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Reports</title>
  <link rel="stylesheet" href="/css/AdminStyles.css" />
  <script src="/js/logout.js" defer></script>
  <script src="/js/reports.js" defer></script>
  <script src="/js/filter.js" defer></script>
  <script src="/js/download.js" defer></script>
  <script src="/js/pagination.js" defer></script>
  <script src="/js/sidebar.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="icon" type="image/png" href="/assets/SUKI Logo 2.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></button>
      <div class="logo">SUKI Incorporation</div>
        <nav class="nav">
          <a href="/admin-dashboard" class="nav-item">
              <i class="fas fa-chart-line"></i><span class="label">Dashboard</span>
          </a>
          <a href="/reports" class="nav-item active">
              <i class="fas fa-file-alt"></i><span class="label">Reports</span>
          </a>
          <a href="/transac" class="nav-item">
              <i class="fas fa-exchange-alt"></i><span class="label">Transactions</span>
          </a>
          <a href="/users/UserManagement" class="nav-item">
              <i class="fa-solid fa-fingerprint"></i><span class="label">Users</span>
          </a>
        </nav>
      </aside>

    <main class="main-content">
      <div class="header">
        <div style="display:flex; align-items:center; gap:12px;">
          <a href="/reports" aria-label="Back to reports"><i class="fas fa-arrow-left" style="color:#000;"></i></a>
          <h1 style="margin:0;">User Activity Reports</h1>
        </div>
      </div>
       <!-- Buttons -->
        <button class = "dls" onclick="quickDownloadCSV()"><i class="fa-solid fa-file-csv"></i>Download CSV</button>
        <button class = "dls" onclick="quickDownloadPDF()"><i class="fa-solid fa-file-pdf"></i>Download PDF</button>
        <!-- Modal -->
        
      <!-- Filters Container -->
      <div class="filters-container" id="filtersContainer">
        <!-- compact, left-aligned filters: reduce spacing and align to start -->
        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:flex-start; margin-bottom:12px;">
          <div style="display:flex; flex-direction:column; gap:6px; min-width:150px;">
            <label for="startDate" style="font-weight:500; font-size:13px;">Date Range:</label>
            <div style="display:flex; align-items:center; gap:8px;">
              <input type="date" id="startDate" name="startDate" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
              <span style="font-weight:500;">to</span>
              <input type="date" id="endDate" name="endDate" style="padding:6px 12px; border-radius:6px; border:1px solid #ccc;">
            </div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; min-width:140px;">
            <label for="activityType" style="font-weight:500; font-size:13px;">Activity Type:</label>
            <select id="activityType" name="activityType" style="padding:6px 8px; border-radius:6px; border:1px solid #ccc; min-width:120px;">
              <option value="">All Activities</option>
              <option value="purchase">Purchase</option>
              <option value="redemption">Redemption</option>
              <option value="refund">Refund</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; min-width:140px;">
            <label for="storeFilter" style="font-weight:500; font-size:13px;">Store:</label>
            <select id="storeFilter" name="store" style="padding:6px 8px; border-radius:6px; border:1px solid #ccc; min-width:120px;">
              <option value="">All Stores</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; min-width:180px;">
            <label style="font-weight:500; font-size:13px;">Filter By Customer:</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <select id="customerFilter" name="customer" style="padding:6px 8px; border-radius:6px; border:1px solid #ccc; min-width:160px;">
                <option value="">Customer</option>
              </select>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="applyFilters" class="filter-btn" style="padding:8px 20px; border-radius:6px; background:#7c0f0f; color:#fff; font-weight:500; border:none;">Apply</button>
            <button id="clearFilters" class="filter-btn" style="padding:8px 20px; border-radius:6px; background:#7c0f0f; color:#fff; font-weight:500; border:none;">Clear</button>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table id="activityTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Activity Type</th>
              <th>Details</th>
                <th>Store</th>
                <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table data will be populated dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <button id="firstPage" class="pagination-btn" disabled>
          <i class="fas fa-angle-double-left"></i> First
        </button>
        <button id="prevPage" class="pagination-btn" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <div class="page-numbers">
          <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </div>
        <button id="nextPage" class="pagination-btn" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
        <button id="lastPage" class="pagination-btn" disabled>
          Last <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </main>
  </div>
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        try {
          // Populate customer select and stores for activity
          async function populateCustomerSelect() {
            try {
              const custRes = await fetch('/reports/activity/users?role=customer');
              const custSel = document.getElementById('customerFilter');

              if (custSel && custRes && custRes.ok) {
                const customers = await custRes.json();
                custSel.innerHTML = '<option value="">Customer</option>';
                if (Array.isArray(customers)) {
                  customers.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.user_id || u.username || '';
                    const full = `${u.first_name || ''} ${u.last_name || ''}`.trim();
                    opt.textContent = full || u.username || opt.value;
                    custSel.appendChild(opt);
                  });
                }
              }
            } catch (e) {
              console.warn('Failed to populate customer select:', e);
            }
          }

          async function populateStoresForRole(role, userId) {
            try {
              let url = '/reports/transactions/stores';
              const qs = [];
              if (role) qs.push(`role=${encodeURIComponent(role)}`);
              if (userId) qs.push(`user=${encodeURIComponent(userId)}`);
              if (qs.length) url += `?${qs.join('&')}`;

              const resStores = await fetch(url);
              if (!resStores.ok) return;
              const stores = await resStores.json();
              const storeSel = document.getElementById('storeFilter');
              if (!storeSel) return;
              storeSel.innerHTML = '<option value="">All Stores</option>';
              if (Array.isArray(stores)) {
                stores.forEach(s => {
                  const opt = document.createElement('option');
                  if (s && typeof s === 'object') {
                    opt.value = s.store_id || s.id || '';
                    opt.textContent = s.store_name || s.name || opt.value;
                  } else {
                    opt.value = s;
                    opt.textContent = s;
                  }
                  storeSel.appendChild(opt);
                });
              }
            } catch (e) {
              console.warn('Could not populate stores list:', e);
            }
          }

          // initial populate and wiring
          await populateCustomerSelect();
          await populateStoresForRole('', '');

          const custSel = document.getElementById('customerFilter');
          if (custSel) {
            custSel.addEventListener('change', function() {
              populateStoresForRole('customer', custSel.value || '');
            });
          }
        } catch (e) {
          console.warn('Could not populate users/stores list:', e);
        }

      try {
        if (typeof applyFilters === 'function') applyFilters();
      } catch (e) {
        console.error('Failed to fetch initial activity data:', e);
      }
    });
</script>
</body>
</html>
