<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SUKI Incorporation - Store Management</title>
  <link rel="stylesheet" href="/css/AdminStyles.css">
  <link rel="icon" type="image/png" href="/assets/SUKI Logo 2.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="/js/logout.js" defer></script>
  <script src="/js/sidebar.js" defer></script>
  <script src="/js/stores.js" defer></script>
  <style>
    .store-thumbnail {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      display: inline-block;
    }
    .store-placeholder {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: #7c7c7c;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></button>
      <div class="logo">SUKI Incorporation</div>
      <nav class="nav">
        <a href="/admin-dashboard" class="nav-item"><i class="fas fa-chart-line"></i><span class="label">Dashboard</span></a>
        <a href="/reports" class="nav-item"><i class="fas fa-file-alt"></i><span class="label">Reports</span></a>
        <a href="/transac" class="nav-item"><i class="fas fa-exchange-alt"></i><span class="label">Transactions</span></a>
        <a href="/users/UserManagement" class="nav-item active"><i class="fa-solid fa-fingerprint"></i><span class="label">Users</span></a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <div>
          <a href="/users/UserManagement"><i class="fas fa-arrow-left" style="color:#000;"></i></a>
          <h1>Store Management</h1>
        </div>
      </div>

      <!-- Stores Table -->
      <div class="tables-section">
        <div class="table-container">
          {{#if stores.length}}
          <table class="admin-table">
            <thead>
              <tr>
                <th></th>
                <th>Store Name</th>
                <th>Owner Name</th>
                <th>Owner Email</th>
                <th>Contact Info</th>
                <th>Store Code</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {{#each stores}}
              <tr>
                <td>
                  {{#if this.store_image}}
                    <img src="{{this.store_image}}" alt="Store Image" class="store-thumbnail">
                  {{else}}
                    <span class="store-placeholder"><i class="fas fa-store"></i></span>
                  {{/if}}
                </td>
                <td>
                  {{this.store_name}}
                </td>
                <td>
                  {{this.ownerFullName}}
                </td>
                <td>
                  {{this.ownerEmail}}
                </td>
                <td>{{this.ownerContact}}</td>
                <td>{{this.store_code}}</td>
                <td>
                  <form class="delete-store-form" data-store-id="{{this.store_id}}" onsubmit="return deleteStore(event, this);">
                    <button type="submit">Delete</button>
                  </form>
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
          {{else}}
          <div style="text-align: center; padding: 60px 20px; color: #666;">
            <i class="fas fa-store" style="font-size: 64px; margin-bottom: 20px; color: #ccc;"></i>
            <h2 style="margin: 0; color: #333;">No stores available at this time</h2>
            <p style="margin: 10px 0 0 0; color: #666;">Start by adding your first store.</p>
          </div>
          {{/if}}
        </div>
      </div>

      <!-- Add Store Buttons -->
      <div style="text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="download-btn" style="background-color: #7c0f0f; color: white;" onclick="showAddStoreForm()">
          <i class="fas fa-plus"></i> Add New Store
        </button>
        <button class="download-btn" style="background-color: #0f7c7c; color: white;" onclick="showAddStoreToExistingOwnerForm()">
          <i class="fas fa-user-plus"></i> Add Store to Existing Owner
        </button>
      </div>

      <!-- Add Store Modal -->
      <div id="addStoreModal" class="modal">
        <div class="modal-content modal-animate">
          <div class="modal-header">
            <h2>Add Store</h2>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
        <form id="addStoreForm" action="/users/stores/add" method="POST" enctype="multipart/form-data">
          <div class="modal-body">
            <!-- Step 1: Store Info -->
            <div class="form-step active" id="step1">
              <div class="uploader">
                <div class="preview-area" id="imagePreview">
                  <i class="fas fa-image" style="font-size:48px;color:#c7c7c7;"></i>
                </div>
                <div>
                  <input class="file-input" type="file" id="storeImage" name="storeImage" accept="image/*" onchange="onImageSelected(event)">
                  <button type="button" class="upload-btn" onclick="document.getElementById('storeImage').click()">
                    <i class="fas fa-upload"></i> Upload Logo
                  </button>
                  <div class="file-name" id="fileName">No file chosen</div>
                </div>
              </div>

              <div class="right-form">
                <div class="form-row full">
                  <label for="storeName">Store Name</label>
                  <input type="text" id="storeName" name="storeName" required>
                </div>

                <div class="form-row full">
                  <label for="location">Store Location</label>
                  <input type="text" id="location" name="location" required>
                </div>

                <div class="form-actions full">
                  <button type="button" class="next-btn" onclick="nextStep(2)">Next →</button>
                </div>
              </div>
            </div>
         <!-- Linear progress bar -->
            <div class="progress-bar">
              <div class="progress-step active" id="progress-step-1">
                <span class="circle">1</span>
                <span class="label">Store Info</span>
              </div>
              <div class="line"></div>
              <div class="progress-step" id="progress-step-2">
                <span class="circle">2</span>
                <span class="label">Owner Info</span>
              </div>
            </div>
            <!-- Step 2: Owner Info -->
            <div class="form-step" id="step2">
              <div class="right-form">
                <div class="form-row">
                  <label for="ownerFirstName">First Name</label>
                  <input type="text" id="ownerFirstName" name="ownerFirstName" required>
                </div>
                <div class="form-row">
                  <label for="ownerLastName">Last Name</label>
                  <input type="text" id="ownerLastName" name="ownerLastName" required>
                </div>
                <div class="form-row">
                  <label for="ownerEmail">Email</label>
                  <input type="email" id="ownerEmail" name="ownerEmail" required>
                </div>
                <div class="form-row">
                  <label for="contactInfo">Contact Information</label>                 
                  <input type="text" id="contactInfo" name="contactInfo" required>
                </div>

                <div class="form-actions full">
                  <button type="button" class="back-btn" onclick="nextStep(1)">← Back</button>
                  <button type="button" class="clear-btn" onclick="clearAddStoreForm()">Clear</button>
                  <button type="submit" class="submit-btn">Add Store</button>
                </div>
              </div>
            </div>
          </div>
          </div>
        </form>
      </div>

      <!-- Add Store to Existing Owner Modal -->
      <div id="addStoreToOwnerModal" class="modal">
        <div class="modal-content modal-animate">
          <div class="modal-header">
            <h2>Add Store to Existing Owner</h2>
            <span class="close" onclick="closeOwnerModal()">&times;</span>
          </div>
          <form id="addStoreToOwnerForm" action="/users/stores/add-to-owner" method="POST" enctype="multipart/form-data">
            <div class="modal-body">
              <div class="uploader">
                <div class="preview-area" id="imagePreviewOwner">
                  <i class="fas fa-image" style="font-size:48px;color:#c7c7c7;"></i>
                </div>
                <div>
                  <input class="file-input" type="file" id="storeImageOwner" name="storeImage" accept="image/*" onchange="onImageSelectedOwner(event)">
                  <button type="button" class="upload-btn" onclick="document.getElementById('storeImageOwner').click()">
                    <i class="fas fa-upload"></i> Upload Logo
                  </button>
                  <div class="file-name" id="fileNameOwner">No file chosen</div>
                </div>
              </div>

              <div class="right-form">
                <div class="form-row full">
                  <label for="ownerSelect">Select Owner</label>
                  <select id="ownerSelect" name="ownerId" required>
                    <option value="">-- Select an Owner --</option>
                  </select>
                </div>

                <div class="form-row full">
                  <label for="storeNameOwner">Store Name</label>
                  <input type="text" id="storeNameOwner" name="storeName" required>
                </div>

                <div class="form-row full">
                  <label for="locationOwner">Store Location</label>
                  <input type="text" id="locationOwner" name="location" required>
                </div>

                <div class="form-actions full">
                  <button type="button" class="clear-btn" onclick="clearOwnerForm()">Clear</button>
                  <button type="submit" class="submit-btn">Add Store</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
  <script>
    function setActiveStep(step) {
      const s1 = document.getElementById('step1');
      const s2 = document.getElementById('step2');
      const p1 = document.getElementById('progress-step-1');
      const p2 = document.getElementById('progress-step-2');

      [s1, s2].forEach(el => { if (el) { el.classList.remove('active'); el.classList.add('animating'); }});

      if (step === 1) {
        s1.classList.add('active');
        s2.classList.remove('active');
        p1.classList.add('active');
        p2.classList.remove('active');
      } else {
        s2.classList.add('active');
        s1.classList.remove('active');
        p2.classList.add('active');
        p1.classList.remove('active');
      }

      // Remove animating class after transition
      setTimeout(() => {
        [s1, s2].forEach(el => el && el.classList.remove('animating'));
      }, 240);
    }

    function nextStep(step) { setActiveStep(step); }

    function showAddStoreForm() {
      document.getElementById('addStoreModal').style.display = 'block';
      document.body.classList.add('modal-open');
      setActiveStep(1);
    }

    function closeModal() {
      document.getElementById('addStoreModal').style.display = 'none';
      document.body.classList.remove('modal-open');
    }

    function onImageSelected(event) {
      const file = event.target.files && event.target.files[0];
      const preview = document.getElementById('imagePreview');
      const fileName = document.getElementById('fileName');
      if (!file) {
        preview.innerHTML = '<i class="fas fa-image" style="font-size:48px;color:#c7c7c7;"></i>';
        fileName.textContent = 'No file chosen';
        return;
      }
      fileName.textContent = file.name;
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.onload = () => URL.revokeObjectURL(img.src);
      preview.innerHTML = '';
      preview.appendChild(img);
    }

    function onImageSelectedOwner(event) {
      const file = event.target.files && event.target.files[0];
      const preview = document.getElementById('imagePreviewOwner');
      const fileName = document.getElementById('fileNameOwner');
      if (!file) {
        preview.innerHTML = '<i class="fas fa-image" style="font-size:48px;color:#c7c7c7;"></i>';
        fileName.textContent = 'No file chosen';
        return;
      }
      fileName.textContent = file.name;
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.onload = () => URL.revokeObjectURL(img.src);
      preview.innerHTML = '';
      preview.appendChild(img);
    }

    async function showAddStoreToExistingOwnerForm() {
      // Load existing owners
      try {
        const response = await fetch('/api/owners');
        const owners = await response.json();
        
        const select = document.getElementById('ownerSelect');
        select.innerHTML = '<option value="">-- Select an Owner --</option>';
        
        owners.forEach(owner => {
          const option = document.createElement('option');
          option.value = owner.user_id;
          option.textContent = `${owner.first_name} ${owner.last_name} (${owner.username})`;
          select.appendChild(option);
        });
        
        document.getElementById('addStoreToOwnerModal').style.display = 'block';
        document.body.classList.add('modal-open');
      } catch (error) {
        console.error('Error loading owners:', error);
        alert('Failed to load owners. Please try again.');
      }
    }

    function closeOwnerModal() {
      document.getElementById('addStoreToOwnerModal').style.display = 'none';
      document.body.classList.remove('modal-open');
      clearOwnerForm();
    }

    function clearOwnerForm() {
      document.getElementById('addStoreToOwnerForm').reset();
      document.getElementById('imagePreviewOwner').innerHTML = '<i class="fas fa-image" style="font-size:48px;color:#c7c7c7;"></i>';
      document.getElementById('fileNameOwner').textContent = 'No file chosen';
    }
  </script>
</body>
</html>