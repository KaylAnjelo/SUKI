<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - SUKI Incorporation</title>
  <link rel="stylesheet" href="/css/OwnerStyles.css">
  <script src="/js/notifications.js" defer></script>
  <script src="/js/logout.js" defer></script>
  <script src="/js/sidebar.js" defer></script>
  <link rel="icon" type="image/png" href="/assets/SUKI Logo 2.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></button>
      <div class="logo">SUKI Incorporation</div>
      <nav class="nav">
        <a href="/owner/dashboard" class="nav-item">
          <i class="fas fa-chart-line"></i><span class="label">Dashboard</span>
        </a>
        <a href="/owner/sales-report" class="nav-item">
          <i class="fas fa-chart-bar"></i><span class="label">Sales Report</span>
        </a>
        <a href="/owner/transactions" class="nav-item">
          <i class="fas fa-exchange-alt"></i><span class="label">Transactions</span>
        </a>
        <a href="/owner/products" class="nav-item">
          <i class="fas fa-box"></i><span class="label">Products</span>
        </a>
        <a href="/owner/promotions" class="nav-item">
          <i class="fas fa-percentage"></i><span class="label">Promotions</span>
        </a>
        <a href="/owner/profile" class="nav-item active">
          <i class="fas fa-user"></i><span class="label">Profile</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <div class="header-left">
          <h1>Profile</h1>
        </div>
        <div class="header-right">
          <!-- Notification icon removed -->
          <div class="user-profile">
            <div class="profile-pic" style="width:48px;height:48px;">
              {{#if user.profile_image}}
                <img src="{{user.profile_image}}" alt="Owner Photo" id="ownerImageHeader" style="width:100%;height:100%;object-fit:cover;border-radius:50%;border:1px solid #e6e6e6;">
              {{else}}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f3f4f6;border-radius:50%;"><i class="fas fa-user" id="ownerIconHeader" style="color:#9ca3af;font-size:18px;"></i></div>
              {{/if}}
            </div>
            <div class="profile-info" style="margin-left:12px;">
              <span style="font-weight:600;font-size:16px;">{{user.first_name}} {{user.last_name}}</span>
            </div>
          </div>
          <form id="logoutForm" action="/logout" method="POST" style="display: inline;">
            <button type="submit" class="logout">Log out</button>
          </form>
        </div>
      </div>
      
      <!-- Profile Content -->
      <div class="profile-content">
        <!-- Profile Details Section -->
        <div class="profile-details-card">
            <div class="profile-picture-container">
            <div class="store-profile-pic" id="storeProfilePic">
              {{#if user.profile_image}}
                <img src="{{user.profile_image}}?t={{timestamp}}" alt="Owner Photo" id="storePhotoImg">
              {{else if store.store_image}}
                <img src="{{store.store_image}}" alt="Store Photo" id="storePhotoImg">
              {{else}}
                <i class="fas fa-store" style="font-size: 48px; color: #9ca3af;"></i>
              {{/if}}
            </div>
          </div>
          <div class="profile-fields">
            <div class="profile-info-row">
              <span class="profile-label">Full Name</span>
              <span class="profile-value" id="ownerName">{{#if user.first_name}}{{user.first_name}} {{user.last_name}}{{else if store}}{{store.owner_name}}{{else}}No Name{{/if}}</span>
            </div>
            <div class="profile-info-row">
              <span class="profile-label">Email</span>
              <span class="profile-value" id="emailDisplay">{{#if user.user_email}}{{user.user_email}}{{else}}No Email{{/if}}</span>
            </div>
            <div class="profile-info-row">
              <span class="profile-label">Phone</span>
              <span class="profile-value" id="phoneDisplay">{{#if user.contact_number}}{{user.contact_number}}{{else if store.owner_contact}}{{store.owner_contact}}{{else}}No Contact{{/if}}</span>
            </div>
            <div class="profile-info-row">
              <span class="profile-label">Address</span>
              <span class="profile-value" id="location">{{#if store}}{{store.location}}{{else}}No Location{{/if}}</span>
            </div>
          </div>
          <div class="profile-actions">
            <button class="edit-profile-btn">Edit</button>
            <button class="change-password-btn">Change Password</button>
          </div>
        </div>

        <!-- Information and My Vendors Section -->
        <div class="profile-bottom-section">
          <!-- Stores Section -->
          <div class="information-card">
            <h3>Stores</h3>
            <div class="stores-list" id="storesList">
              {{#if stores}}
                {{#each stores}}
                  <div class="store-item" data-store-id="{{this.store_id}}">
                    <div class="store-item-image">
                      {{#if this.store_image}}
                        <img src="{{this.store_image}}" alt="{{this.store_name}}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                      {{else}}
                        <i class="fas fa-store" style="font-size: 24px; color: #9ca3af;"></i>
                      {{/if}}
                    </div>
                    <div class="store-item-info">
                      <p class="store-item-name">{{this.store_name}}</p>
                      <p class="store-item-code" style="font-size:13px;color:#7c0f0f;font-weight:500;">Code: {{this.store_code}}</p>
                      <p class="store-item-location">{{this.location}}</p>
                    </div>
                    <button class="btn-edit-store" data-store-id="{{this.store_id}}">
                      <i class="fas fa-edit"></i>
                    </button>
                  </div>
                {{/each}}
              {{else}}
                <p>No stores available</p>
              {{/if}}
            </div>
          </div>

          <!-- My Vendors Section -->
          <div class="vendors-card">
            <h3>My Vendors</h3>
            <div class="vendors-table-container">
              <table class="vendors-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Store</th>
                    <th>Contact #</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each vendors}}
                  <tr>
                    <td>{{first_name}} {{last_name}}</td>
                    <td>{{store_name}}</td>
                    <td>{{contact_number}}</td>
                    <td>{{user_email}}</td>
                  </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editProfileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #ffffff;">Edit Profile</h2>
        <span class="close">&times;</span>
      </div>
      <form id="editProfileForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="editOwnerName">Owner Name</label>
          <input type="text" id="editOwnerName" name="ownerName" required>
        </div>

        <!-- Profile photo upload -->
        <div class="form-group">
          <label for="editProfilePhoto">Profile Photo</label>
            <div class="photo-upload-container">
            <input type="file" id="editProfilePhoto" name="ownerProfilePhoto" accept="image/*" class="photo-input" style="display:none;">
            <div class="photo-preview" id="profilePhotoPreview">
              <i class="fas fa-user" style="font-size:48px;color:#9ca3af;"></i>
            </div>
            <button type="button" class="btn-remove-photo" id="removeProfilePhotoBtn" style="display:none;margin-top:8px;">Remove Photo</button>
          </div>
        </div>

        <div class="form-group">
          <label for="editContactNumber">Contact Number</label>
          <input type="tel" id="editContactNumber" name="contactNumber" required>
        </div>
        <div class="form-group">
          <label for="editEmail">Email</label>
          <input type="email" id="editEmail" name="email" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Store Modal -->
  <div id="editStoreModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: #ffffff;">Edit Store</h2>
        <span class="close-store">&times;</span>
      </div>
      <form id="editStoreForm" enctype="multipart/form-data">
        <input type="hidden" id="editStoreId" name="storeId">
        
        <!-- Store photo upload -->
        <div class="form-group">
          <label for="editStorePhoto">Store Photo</label>
          <div class="photo-upload-container">
            <input type="file" id="editStorePhoto" name="storeImage" accept="image/*" class="photo-input" style="display:none;">
            <div class="photo-preview" id="storePhotoPreview">
              <i class="fas fa-store" style="font-size: 48px; color: #9ca3af;"></i>
            </div>
            <button type="button" class="btn-remove-photo" id="removeStorePhotoBtn" style="display: none; margin-top: 8px;">Remove Photo</button>
          </div>
        </div>

        <div class="form-group">
          <label for="editStoreNameInput">Store Name</label>
          <input type="text" id="editStoreNameInput" name="storeName" required>
        </div>

        <div class="form-group">
          <label for="editStoreLocation">Location</label>
          <input type="text" id="editStoreLocation" name="location" required>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel-store">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="modal">
    <div class="modal-content" style="padding: 32px 24px;">
      <div class="modal-header">
        <h2 style="color: #ffffff;">Change Password</h2>
        <span class="close-password">&times;</span>
      </div>
      <form id="requestCodeForm" style="margin-bottom: 16px;">
        <div id="emailStep">
          <label>Your verification code will be sent to your registered email:</label>
          <div style="margin-bottom: 12px; font-weight: bold; color: #7D0006;">{{user.user_email}}</div>
          <button type="button" id="sendCodeBtn" class="btn-save" style="margin-bottom: 8px;">Send Code</button>
        </div>
        <div id="codeStep" style="display:none;">
          <label for="emailCode">Enter the code sent to your email:</label>
          <input type="text" id="emailCode" name="emailCode" required maxlength="6" style="margin-bottom: 12px;">
          <button type="button" id="verifyCodeBtn" class="btn-save" style="margin-bottom: 8px;">Verify Code</button>
        </div>
      </form>
      <form id="changePasswordForm" style="display:none;">
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const sendCodeBtn = document.getElementById('sendCodeBtn');
                const verifyCodeBtn = document.getElementById('verifyCodeBtn');
                const emailStep = document.getElementById('emailStep');
                const codeStep = document.getElementById('codeStep');
                const changePasswordForm = document.getElementById('changePasswordForm');
                const userEmail = '{{user.user_email}}';

                sendCodeBtn.addEventListener('click', async function() {
                  sendCodeBtn.disabled = true;
                  sendCodeBtn.textContent = 'Sending...';
                  try {
                    const res = await fetch('/owner/profile/send-password-code', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ email: userEmail })
                    });
                    const data = await res.json();
                    if (data.success) {
                      emailStep.style.display = 'none';
                      codeStep.style.display = 'block';
                      alert('Verification code sent to your email.');
                    } else {
                      alert(data.error || 'Failed to send code.');
                    }
                  } catch (err) {
                    alert('Error sending code.');
                  }
                  sendCodeBtn.disabled = false;
                  sendCodeBtn.textContent = 'Send Code';
                });

                verifyCodeBtn.addEventListener('click', async function() {
                  const code = document.getElementById('emailCode').value;
                  if (!code) return alert('Please enter the code.');
                  verifyCodeBtn.disabled = true;
                  verifyCodeBtn.textContent = 'Verifying...';
                  try {
                    const res = await fetch('/owner/profile/verify-password-code', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ email: userEmail, code })
                    });
                    const data = await res.json();
                    if (data.success) {
                      codeStep.style.display = 'none';
                      changePasswordForm.style.display = 'block';
                      alert('Code verified. You may now change your password.');
                    } else {
                      alert(data.error || 'Invalid code.');
                    }
                  } catch (err) {
                    alert('Error verifying code.');
                  }
                  verifyCodeBtn.disabled = false;
                  verifyCodeBtn.textContent = 'Verify Code';
                });
              });
            </script>
        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" name="currentPassword" required>
        </div>
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" name="newPassword" required minlength="6">
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel-password">Cancel</button>
          <button type="submit" class="btn-save">Change Password</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Profile page loaded');
      
      // Store selector functionality
      const storeSelector = document.getElementById('storeSelector');
      if (storeSelector) {
        storeSelector.addEventListener('change', (e) => {
          const storeId = e.target.value;
          // Reload page with selected store
          window.location.href = `/owner/profile?store_id=${storeId}`;
        });
      }
      
      // Modal elements
      const modal = document.getElementById('editProfileModal');
      const editProfileBtn = document.querySelector('.edit-profile-btn');
      const closeBtn = document.querySelector('.close');
      const cancelBtn = document.querySelector('.btn-cancel');
      const editForm = document.getElementById('editProfileForm');
      
      // Open modal when edit button is clicked
      if (editProfileBtn) {
        editProfileBtn.addEventListener('click', async () => {
          try {
            // Fetch current profile data
            const response = await fetch('/owner/profile', {
              headers: { 'Accept' : 'application/json' }
            });
            const data = await response.json();
            
            if (response.ok) {
              // Populate form with current data
              // Prefill owner name from user first/last name when available, otherwise fallback to store owner_name
              const ownerNameField = document.getElementById('editOwnerName');
              const userFirst = data.user?.first_name || '';
              const userLast = data.user?.last_name || '';
              const userFull = (userFirst + ' ' + userLast).trim();
              ownerNameField.value = userFull || data.store?.owner_name || '';
              document.getElementById('editContactNumber').value = data.user?.contact_number || data.store?.owner_contact || '';
              document.getElementById('editEmail').value = data.user?.user_email || '';
              
              // Populate profile photo preview and remove button
              const profilePreview = document.getElementById('profilePhotoPreview');
              const removeBtn = document.getElementById('removeProfilePhotoBtn');
              const profileInput = document.getElementById('editProfilePhoto');
              // Remove any previous remove input flag
              const existingRemove = document.getElementById('removePhotoInput');
              if (existingRemove) existingRemove.remove();

              // Show the user's profile image (not the store image) in the owner modal
              if (data.user && data.user.profile_image) {
                profilePreview.innerHTML = `<img src="${data.user.profile_image}" alt="Profile Photo" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
                if (removeBtn) removeBtn.style.display = 'inline-block';
              } else {
                profilePreview.innerHTML = '<i class="fas fa-user" style="font-size:32px;color:#9ca3af;"></i>';
                if (removeBtn) removeBtn.style.display = 'none';
              }

              // Clear file input
              if (profileInput) profileInput.value = '';
              
              // Show modal
              modal.style.display = 'block';
            } else {
              alert('Failed to load profile data');
            }
          } catch (error) {
            console.error('Error loading profile data:', error);
            alert('Failed to load profile data');
          }
        });
      }
      
      // Close modal when X is clicked
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          modal.style.display = 'none';
        });
      }
      
      // Close modal when Cancel is clicked
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          modal.style.display = 'none';
        });
      }
      
      // Close modal when clicking outside of it
      window.addEventListener('click', (event) => {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
      
      // Handle form submission
      if (editForm) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(editForm);
          
          // Explicitly add removePhoto if the hidden input exists
          const removeInput = document.getElementById('removePhotoInput');
          if (removeInput && removeInput.value === 'true') {
            formData.set('removePhoto', 'true');
          }
          
          // Show loading state
          const saveBtn = document.querySelector('.btn-save');
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Saving...';
          saveBtn.disabled = true;
          
          try {
            const response = await fetch('/owner/profile', {
              method: 'PUT',
              body: formData // Send FormData directly for file upload
            });
            
            const result = await response.json();
            
            if (response.ok) {
              // Close modal
              modal.style.display = 'none';
              
              // Show success message
              alert('Profile updated successfully!');
              
              // Reload the page to reflect all changes
              window.location.reload();
            } else {
              alert('Failed to update profile: ' + (result.error || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error updating profile:', error);
            alert('Failed to update profile');
          } finally {
            // Reset button state
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }
        });
      }

      // Profile photo input and remove button handling
      const profilePreview = document.getElementById('profilePhotoPreview');
      const profileInput = document.getElementById('editProfilePhoto');
      const removeProfileBtn = document.getElementById('removeProfilePhotoBtn');

      if (profilePreview && profileInput) {
        // Clicking preview opens file picker
        profilePreview.addEventListener('click', () => {
          profileInput.click();
        });

        // When a file is selected, preview it and remove any "removePhotoInput" flag
        profileInput.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            profilePreview.innerHTML = `<img src="${ev.target.result}" alt="Selected Photo" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
            if (removeProfileBtn) removeProfileBtn.style.display = 'inline-block';
            // Remove removePhotoInput if present since user chose new photo
            const existingRemove = document.getElementById('removePhotoInput');
            if (existingRemove) existingRemove.remove();
          };
          reader.readAsDataURL(file);
        });
      }

      if (removeProfileBtn) {
        removeProfileBtn.addEventListener('click', (e) => {
          e.preventDefault();
          // Clear file input
          if (profileInput) profileInput.value = '';
          // Reset preview to placeholder
          profilePreview.innerHTML = '<i class="fas fa-user" style="font-size:32px;color:#9ca3af;"></i>';
          removeProfileBtn.style.display = 'none';
          // Add hidden input to indicate removal on submit
          let removeInput = document.getElementById('removePhotoInput');
          if (!removeInput) {
            removeInput = document.createElement('input');
            removeInput.type = 'hidden';
            removeInput.id = 'removePhotoInput';
            removeInput.name = 'removePhoto';
            removeInput.value = 'true';
            editForm.appendChild(removeInput);
          } else {
            removeInput.value = 'true';
          }
        });
      }

      // Edit Store Modal
      const storeModal = document.getElementById('editStoreModal');
      const closeStoreBtn = document.querySelector('.close-store');
      const cancelStoreBtn = document.querySelector('.btn-cancel-store');
      const editStoreForm = document.getElementById('editStoreForm');
      
      // Open store edit modal when edit button is clicked
      document.addEventListener('click', async (e) => {
        if (e.target.closest('.btn-edit-store')) {
          const storeId = e.target.closest('.btn-edit-store').dataset.storeId;
          
          try {
            // Fetch store data
            const urlParams = new URLSearchParams(window.location.search);
            const currentStoreId = urlParams.get('store_id') || storeId;
            
            const response = await fetch(`/owner/profile?store_id=${storeId}`, {
              headers: { 'Accept': 'application/json' }
            });
            const data = await response.json();
            
            if (response.ok && data.store) {
              // Populate form with current data
              document.getElementById('editStoreId').value = data.store.store_id;
              document.getElementById('editStoreNameInput').value = data.store.store_name || '';
              document.getElementById('editStoreLocation').value = data.store.location || '';
              
              // Set current photo preview
              const storePhotoPreview = document.getElementById('storePhotoPreview');
              if (data.store.store_image) {
                storePhotoPreview.innerHTML = `<img src="${data.store.store_image}" alt="Current Store Photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                document.getElementById('removeStorePhotoBtn').style.display = 'block';
              } else {
                storePhotoPreview.innerHTML = '<i class="fas fa-store" style="font-size: 48px; color: #9ca3af;"></i>';
                document.getElementById('removeStorePhotoBtn').style.display = 'none';
              }
              
              // Show modal
              storeModal.style.display = 'block';
            } else {
              alert('Failed to load store data');
            }
          } catch (error) {
            console.error('Error loading store data:', error);
            alert('Failed to load store data');
          }
        }
      });
      
      // Close store modal
      if (closeStoreBtn) {
        closeStoreBtn.addEventListener('click', () => {
          storeModal.style.display = 'none';
        });
      }
      
      if (cancelStoreBtn) {
        cancelStoreBtn.addEventListener('click', () => {
          storeModal.style.display = 'none';
        });
      }
      
      // Close when clicking outside
      window.addEventListener('click', (event) => {
        if (event.target === storeModal) {
          storeModal.style.display = 'none';
        }
      });
      
      // Handle store photo file selection
      const storePhotoInput = document.getElementById('editStorePhoto');
      const storePhotoPreview = document.getElementById('storePhotoPreview');
      const removeStorePhotoBtn = document.getElementById('removeStorePhotoBtn');
      
      // Make photo preview clickable
      if (storePhotoPreview) {
        storePhotoPreview.addEventListener('click', () => {
          storePhotoInput.click();
        });
        storePhotoPreview.style.cursor = 'pointer';
      }
      
      if (storePhotoInput) {
        storePhotoInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              storePhotoPreview.innerHTML = `<img src="${e.target.result}" alt="Selected Photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
              removeStorePhotoBtn.style.display = 'block';
              
              // Remove the hidden field since we're uploading a new photo
              const removeInput = document.getElementById('removeStorePhotoInput');
              if (removeInput) {
                removeInput.remove();
              }
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      // Handle remove store photo button
      if (removeStorePhotoBtn) {
        removeStorePhotoBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          storePhotoInput.value = '';
          storePhotoPreview.innerHTML = '<i class="fas fa-store" style="font-size: 48px; color: #9ca3af;"></i>';
          removeStorePhotoBtn.style.display = 'none';
          
          // Add a hidden field to indicate photo removal
          let removeInput = document.getElementById('removeStorePhotoInput');
          if (!removeInput) {
            removeInput = document.createElement('input');
            removeInput.type = 'hidden';
            removeInput.id = 'removeStorePhotoInput';
            removeInput.name = 'removePhoto';
            removeInput.value = 'true';
            editStoreForm.appendChild(removeInput);
          } else {
            removeInput.value = 'true';
          }
        });
      }
      
      // Handle store form submission
      if (editStoreForm) {
        editStoreForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const formData = new FormData(editStoreForm);
          const storeId = formData.get('storeId');
          
          // Explicitly add removePhoto if the hidden input exists
          const removeInput = document.getElementById('removeStorePhotoInput');
          if (removeInput && removeInput.value === 'true') {
            formData.set('removePhoto', 'true');
          }
          
          // Show loading state
          const saveBtn = editStoreForm.querySelector('.btn-save');
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Saving...';
          saveBtn.disabled = true;
          
          try {
            const response = await fetch(`/owner/stores/${storeId}`, {
              method: 'PUT',
              body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
              // Close modal
              storeModal.style.display = 'none';
              
              // Show success message
              alert('Store updated successfully!');
              
              // Reload the page to reflect all changes
              window.location.reload();
            } else {
              alert('Failed to update store: ' + (result.error || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error updating store:', error);
            alert('Failed to update store');
          } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          }
        });
      }

      // Change Password Modal
      const passwordModal = document.getElementById('changePasswordModal');
      const changePasswordBtn = document.querySelector('.change-password-btn');
      const closePasswordBtn = document.querySelector('.close-password');
      const cancelPasswordBtn = document.querySelector('.btn-cancel-password');
      const changePasswordForm = document.getElementById('changePasswordForm');
      
      // Open password modal
      if (changePasswordBtn) {
        changePasswordBtn.addEventListener('click', () => {
          passwordModal.style.display = 'block';
        });
      }
      
      // Close password modal
      if (closePasswordBtn) {
        closePasswordBtn.addEventListener('click', () => {
          passwordModal.style.display = 'none';
          changePasswordForm.reset();
        });
      }
      
      if (cancelPasswordBtn) {
        cancelPasswordBtn.addEventListener('click', () => {
          passwordModal.style.display = 'none';
          changePasswordForm.reset();
        });
      }
      
      // Close when clicking outside
      window.addEventListener('click', (event) => {
        if (event.target === passwordModal) {
          passwordModal.style.display = 'none';
          changePasswordForm.reset();
        }
      });
      
      // Handle password change form submission
      if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmPassword').value;
          
          // Validate passwords match
          if (newPassword !== confirmPassword) {
            alert('New passwords do not match!');
            return;
          }
          
          // Show loading state
          const saveBtn = changePasswordForm.querySelector('.btn-save');
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'Changing...';
          saveBtn.disabled = true;
          
          try {
            const response = await fetch('/owner/change-password', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                currentPassword,
                newPassword
              })
            });
            
            const result = await response.json();
            
            if (response.ok) {
              alert('Password changed successfully!');
              passwordModal.style.display = 'none';
              changePasswordForm.reset();
            } else {
              alert('Failed to change password: ' + (result.error || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error changing password:', error);
            alert('Failed to change password');
          } finally {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
           }
        });
      }
    });
  </script>
</body>
</html>
